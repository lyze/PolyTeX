var PDFTeX=function(e){e||(e="pdftex-worker.js");var o=new Worker(e);this.worker=o;var n=this,t=!1;n.on_stdout=function(e){console.log(e)},n.on_stderr=function(e){console.log(e)},o.onmessage=function(e){var o,t=JSON.parse(e.data);switch("command"in t||console.log("missing command!",t),t.command){case"ready":r.done(!0);break;case"stdout":case"stderr":n["on_"+t.command](t.contents);break;default:o=t.msg_id,"msg_id"in t&&o in i?i[o].done(t.result):console.warn("Unknown worker message "+o+"!")}};var r=new promise.Promise,i=[],a=void 0,l=function(e){var n=new promise.Promise,t=i.push(n)-1;return r.then(function(){e.msg_id=t,o.postMessage(JSON.stringify(e))}),n},c=function(){for(var e,o=1024,n=void 0,t=void 0,r=o,i=!0;Math.abs(r)>100;){i?(t=o,r="undefined"==typeof n?o:(n-o)/2):(n=o,r="undefined"==typeof t?-1*o/2:-1*(o-t)/2),o+=r,i=!0;try{e=String.fromCharCode.apply(null,new Uint8Array(o)),l({command:"test",data:e})}catch(a){i=!1}}return o},s=function(e){n[e]=function(){var o=[].concat.apply([],arguments);return l({command:e,arguments:o})}};s("FS_createDataFile"),s("FS_readFile"),s("FS_unlink"),s("FS_createFolder"),s("FS_createPath"),s("FS_createLazyFile"),s("FS_createLazyFilesFromList"),s("set_TOTAL_MEMORY");var u=function(e,o,n){return function(){return e[o].apply(e,n)}};n.compile=function(e){var o=new promise.Promise;return n.compileRaw(e).then(function(e){return e===!1?o.done(!1):(pdf_dataurl="data:application/pdf;charset=binary;base64,"+window.btoa(e),o.done(pdf_dataurl))}),o},n.compileRaw=function(e){"undefined"==typeof a&&(a=c());var o;o=t?[u(n,"FS_unlink",["/input.tex"])]:[u(n,"FS_createDataFile",["/","input.tex",e,!0,!0]),u(n,"FS_createLazyFilesFromList",["/","texlive.lst","./texlive",!0,!0])];var r=function(){return t=!0,l({command:"run",arguments:["-interaction=nonstopmode","-output-format","pdf","input.tex"]})},i=function(){return console.log(arguments),n.FS_readFile("/input.pdf")};return promise.chain(o).then(r).then(i)}},babelHelpers={};babelHelpers.classCallCheck=function(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")},babelHelpers.createClass=function(){function e(e,o){for(var n=0;n<o.length;n++){var t=o[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(o,n,t){return n&&e(o.prototype,n),t&&e(o,t),o}}();var WrappedPromise=function(){var e=this;this.promise=new Promise(function(o,n){e.resolve=o,e.reject=n})};WrappedPromise.prototype.done=function(e){this.resolve(e)},WrappedPromise.prototype.then=function(){return this.promise.then.apply(this.promise,arguments)};var chain=function e(o,n){var t=new WrappedPromise;return 0===o.length?t.done(n):o[0].apply(null,n).then(function(){o.splice(0,1),e(o,arguments).then(function(){t.done.apply(t,arguments)})}),t};window.promise={Promise:WrappedPromise,chain:chain};var CompilationService=function(){function e(){babelHelpers.classCallCheck(this,e),this.pdftex=new PDFTeX("bower_components/texlivejs/pdftex-worker.js")}return babelHelpers.createClass(e,[{key:"compile",value:function(e,o){var n=this;this.pdftex.worker.terminate(),this.pdftex=new PDFTeX("bower_components/texlivejs/pdftex-worker.js");var t=this.pdftex.set_TOTAL_MEMORY(83886080);return t.then(function(){return n.pdftex.on_stdout=o,n.pdftex.on_stderr=o,n.pdftex.compile(e)})}}]),e}();!function(e){"use strict";var o=new CompilationService,n=e.querySelector("#app");n.a11yTarget=e.body,n.baseUrl="/",""===window.location.port&&(n.baseUrl="/PolyTeX/"),n.displayInstalledToast=function(){Polymer.dom(e).querySelector("platinum-sw-cache").disabled||Polymer.dom(e).querySelector("#caching-complete").show()},n.endCloudIntegration=function(){},n.isConnectCloudItemDisabled=function(e){return["loading","unavailable","authorizing"].includes(e)},n.isConnectCloudItemHidden=function(e){return!["loading","unavailable","unauthorized","authorizing"].includes(e)},n.addEventListener("dom-change",function(){}),n.filename="untitled.tex",n.isCompiling=!1,n.codeMirrorOptions={mode:"stex",lineWrapping:!0,lineNumbers:!0},window.addEventListener("WebComponentsReady",function(){var t=(Polymer.dom(e).querySelector("#filenameTextArea"),Polymer.dom(e).querySelector("#editor")),r=Polymer.dom(e).querySelector("#generatePreviewButton"),i=Polymer.dom(e).querySelector("#compileProgress"),a=Polymer.dom(e).querySelector("#previewIFrame"),l=Polymer.dom(e).querySelector("#preview"),c=(Polymer.dom(e).querySelector("#compileProblemToast"),Polymer.dom(e).querySelector("#compileLog")),s=Polymer.dom(e).querySelector("#compileLogTextArea");Polymer.dom(e).querySelector("#apiErrorToast"),Polymer.dom(e).querySelector("#googleSignIn");c.fitInto=l,n.toggleCompileLog=function(e){c.toggle()},r.addEventListener("click",function(e){var r=new Date;if(n.isCompiling=!0,"in-progress"!==n.compileStatus){n.compileStatus="in-progress",console.log("Started compilation at "+r),s.value="",c.refit();var l=function(e){void 0!==e&&null!==e&&(s.value+=e+"\n",c.refit());var o=/Fatal error occurred, no output PDF file produced!$/;if(o.test(e)){var t=new Date;console.error(e),n.compilationError=e,n.isCompiling=!1,n.compileStatus="error",console.log("Finished compilation at "+t),console.log("Execution time: "+(t-r)+"ms")}};o.compile(t.getValue(),l).then(function(e){if(console.log(e),!e)throw n.compileStatus="error",new Error("No PDF data URL");var o=new Date;n.isCompiling=!1,console.log("Finished compilation at "+o),console.log("Execution time: "+(o-r)+"ms"),e?(a.setAttribute("src",e),n.compileStatus="ok"):(a.setAttribute("src","about:blank"),n.compileStatus="error"),i.style.display="none"})["catch"](function(e){console.error(e),n.compilationError=e.message,n.isCompiling=!1,n.compileStatus="error"})}});var u=Polymer.dom(e).querySelector("#drawerPanel");n.doSaveItemAction=function(){n.fileId&&(u.closeDrawer(),n.doManualSave.apply(n,arguments))},n.doHelloWorld=function(){t.getValue()&&!confirm("Do you really want to discard your changes?")||(t.setValue("\\documentclass{article}\n\n\\begin{document}\nHello, world!\n\\end{document}"),u.closeDrawer())},n.connectCloud=function(){u.closeDrawer(),t.connectCloud()["catch"](function(e){n.apiErrorMessage="Failed to connect to Google Drive."})},n.disconnectCloud=function(){u.closeDrawer(),t.endCloudIntegration()},n.startCloudIntegration=function(){t.startCloudIntegration()},n.endCloudIntegration=function(){n.webViewLink=null,n.fileId=null,n.lastCloudModificationTime=null,t.endCloudIntegration()},t.addEventListener("cloud-ready",function(){}),t.addEventListener("cloud-file-loaded",function(e){var o=e.detail.result,r=(o.id,o.name),i=(o.webViewLink,o.createdTime),a=o.modifiedTime;i&&(n.savedMessage="Created "+r+" at "+new Date(i)),a&&(n.lastCloudModificationTime=new Date(a)),n.doManualSave=function(e,o){t.save().then(function(e){return n.savedMessage="Saved "+r+" at "+new Date},function(e){return n.apiErrorMessage=e.error.message}),o.keyboardEvent.preventDefault()}}),n.maybeStartCloudIntegration=function(){}})}(document);