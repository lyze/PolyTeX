function newDriveAndRealtimePromise(e,t){var n;n=t.libraryLoaded?Promise.resolve(t.api):new Promise(function(e,n){t.addEventListener("api-load",function(t){return e(t.target.api)}),t.addEventListener("library-error-message-changed",function(e){return n(e.detail.value)})});var o=new Promise(function(t,n){e.addEventListener("google-api-load",function(e){var n=e.target.auth;Auth._authorize(n,function(n){return t(e.target.api)})}),e.addEventListener("google-api-load-error",function(e){return n(e.detail.value)})});return Promise.all([o,n]).then(function(e){var t=babelHelpers.slicedToArray(e,2),n=t[0],o=t[1],r=new Realtime(o,new Auth(window.gapi.auth)),i=new Drive(n,window.gapi);return[i,r]})}var PDFTeX=function(e){e||(e="pdftex-worker.js");var t=new Worker(e);this.worker=t;var n=this,o=!1;n.on_stdout=function(e){console.log(e)},n.on_stderr=function(e){console.log(e)},t.onmessage=function(e){var t,o=JSON.parse(e.data);switch("command"in o||console.log("missing command!",o),o.command){case"ready":r.done(!0);break;case"stdout":case"stderr":n["on_"+o.command](o.contents);break;default:t=o.msg_id,"msg_id"in o&&t in i?i[t].done(o.result):console.warn("Unknown worker message "+t+"!")}};var r=new promise.Promise,i=[],a=void 0,l=function(e){var n=new promise.Promise,o=i.push(n)-1;return r.then(function(){e.msg_id=o,t.postMessage(JSON.stringify(e))}),n},s=function(){for(var e,t=1024,n=void 0,o=void 0,r=t,i=!0;Math.abs(r)>100;){i?(o=t,r="undefined"==typeof n?t:(n-t)/2):(n=t,r="undefined"==typeof o?-1*t/2:-1*(t-o)/2),t+=r,i=!0;try{e=String.fromCharCode.apply(null,new Uint8Array(t)),l({command:"test",data:e})}catch(a){i=!1}}return t},c=function(e){n[e]=function(){var t=[].concat.apply([],arguments);return l({command:e,arguments:t})}};c("FS_createDataFile"),c("FS_readFile"),c("FS_unlink"),c("FS_createFolder"),c("FS_createPath"),c("FS_createLazyFile"),c("FS_createLazyFilesFromList"),c("set_TOTAL_MEMORY");var u=function(e,t,n){return function(){return e[t].apply(e,n)}};n.compile=function(e){var t=new promise.Promise;return n.compileRaw(e).then(function(e){return e===!1?t.done(!1):(pdf_dataurl="data:application/pdf;charset=binary;base64,"+window.btoa(e),t.done(pdf_dataurl))}),t},n.compileRaw=function(e){"undefined"==typeof a&&(a=s());var t;t=o?[u(n,"FS_unlink",["/input.tex"])]:[u(n,"FS_createDataFile",["/","input.tex",e,!0,!0]),u(n,"FS_createLazyFilesFromList",["/","texlive.lst","./texlive",!0,!0])];var r=function(){return o=!0,l({command:"run",arguments:["-interaction=nonstopmode","-output-format","pdf","input.tex"]})},i=function(){return console.log(arguments),n.FS_readFile("/input.pdf")};return promise.chain(t).then(r).then(i)}},babelHelpers={};babelHelpers.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},babelHelpers.createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),babelHelpers.slicedToArray=function(){function e(e,t){var n=[],o=!0,r=!1,i=void 0;try{for(var a,l=e[Symbol.iterator]();!(o=(a=l.next()).done)&&(n.push(a.value),!t||n.length!==t);o=!0);}catch(s){r=!0,i=s}finally{try{!o&&l["return"]&&l["return"]()}finally{if(r)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();var WrappedPromise=function(){var e=this;this.promise=new Promise(function(t,n){e.resolve=t,e.reject=n})};WrappedPromise.prototype.done=function(e){this.resolve(e)},WrappedPromise.prototype.then=function(){return this.promise.then.apply(this.promise,arguments)};var chain=function e(t,n){var o=new WrappedPromise;return 0===t.length?o.done(n):t[0].apply(null,n).then(function(){t.splice(0,1),e(t,arguments).then(function(){o.done.apply(o,arguments)})}),o};window.promise={Promise:WrappedPromise,chain:chain};var CompilationService=function(){function e(){babelHelpers.classCallCheck(this,e),this.pdftex=new PDFTeX("bower_components/texlivejs/pdftex-worker.js")}return babelHelpers.createClass(e,[{key:"compile",value:function(e,t){var n=this;this.pdftex.worker.terminate(),this.pdftex=new PDFTeX("bower_components/texlivejs/pdftex-worker.js");var o=this.pdftex.set_TOTAL_MEMORY(83886080);return o.then(function(){return n.pdftex.on_stdout=t,n.pdftex.on_stderr=t,n.pdftex.compile(e)})}}]),e}(),CLIENT_ID="707726290441-2t740vcema93b7jad2acqiku87qe25s6.apps.googleusercontent.com",SCOPES=["https://www.googleapis.com/auth/drive.install","https://www.googleapis.com/auth/drive.file"],AUTH_PARAMS={client_id:CLIENT_ID,scope:SCOPES,immediate:!0},Auth=function(){function e(t){babelHelpers.classCallCheck(this,e),this.auth=t}return babelHelpers.createClass(e,[{key:"authorize",value:function(e){this.auth.authorize(AUTH_PARAMS,e)}}],[{key:"_authorize",value:function(e,t){e.authorize(AUTH_PARAMS,t)}}]),e}(),Realtime=function(){function e(t,n){babelHelpers.classCallCheck(this,e),this.api=t,this.auth=n}return babelHelpers.createClass(e,[{key:"load",value:function(e,t,n,o){var r=this;return this.api.load(e,t,n,function(i){i.type===r.realtime.ErrorType.TOKEN_REFRESH_REQUIRED?(console.log("Reauthorizing..."),r.auth.authorize(function(i){console.log("Reauthorized."),r.api.load(e,t,n,function(t){console.error("Failed to load realtime document for file "+e+" after attempting reauthorization.",t),o(t)})})):o(i)})}}]),e}(),Drive=function(){function e(t,n){babelHelpers.classCallCheck(this,e),this.drive=t,this.gapi=n}return babelHelpers.createClass(e,[{key:"createTeXFile",value:function(e,t){var n={name:e,mimeType:"application/x-tex",useContentAsIndexableText:!0};return this.drive.files.create(Object.assign(n,t))}},{key:"uploadTeXFile",value:function(e,t,n){return this.gapi.client.request({path:"/upload/drive/v3/files/"+e,method:"PATCH",params:Object.assign({uploadType:"media",useContentAsIndexableText:!0},n),headers:{"Content-Type":"application/x-tex"},body:t})}}]),e}();!function(e,t){"use strict";var n=new CompilationService,o=e.querySelector("#app");o.a11yTarget=e.body,o.baseUrl="/",""===window.location.port&&(o.baseUrl="/PolyTeX/"),o.displayInstalledToast=function(){t.dom(e).querySelector("platinum-sw-cache").disabled||t.dom(e).querySelector("#caching-complete").show()},o.addEventListener("dom-change",function(){}),o.filename="PolyTeX",o.isCompiling=!1,o.codeMirrorOptions={mode:"stex",lineWrapping:!0,lineNumbers:!0},o.fileId=null,o.endDriveIntegration=function(){o.webViewLink=void 0,o.fileId=null},window.addEventListener("WebComponentsReady",function(){var r=t.dom(e).querySelector("#editor"),i=t.dom(e).querySelector("#generatePreviewButton"),a=t.dom(e).querySelector("#compileProgress"),l=t.dom(e).querySelector("#previewIFrame"),s=t.dom(e).querySelector("#preview"),c=(t.dom(e).querySelector("#compileProblemToast"),t.dom(e).querySelector("#compileLog")),u=t.dom(e).querySelector("#compileLogTextArea");t.dom(e).querySelector("#apiErrorToast");c.fitInto=s,o.toggleCompileLog=function(e){c.toggle()},i.addEventListener("click",function(e){var t=new Date;if(o.isCompiling=!0,"in-progress"!==o.compileStatus){o.compileStatus="in-progress",console.log("Started compilation at "+t),u.value="",c.refit();var i=function(e){void 0!==e&&null!==e&&(u.value+=e+"\n",c.refit());var n=/Fatal error occurred, no output PDF file produced!$/;if(n.test(e)){var r=new Date;console.error(e),o.compilationError=e,o.isCompiling=!1,o.compileStatus="error",console.log("Finished compilation at "+r),console.log("Execution time: "+(r-t)+"ms")}};n.compile(r.getValue(),i).then(function(e){if(console.log(e),!e)throw o.compileStatus="error",new Error("No PDF data URL");var n=new Date;o.isCompiling=!1,console.log("Finished compilation at "+n),console.log("Execution time: "+(n-t)+"ms"),e?(l.setAttribute("src",e),o.compileStatus="ok"):(l.setAttribute("src","about:blank"),o.compileStatus="error"),a.style.display="none"})["catch"](function(e){console.error(e),o.compilationError=e.message,o.isCompiling=!1,o.compileStatus="error"})}});var d=t.dom(e).querySelector("#drawerPanel");o.doSaveItemAction=function(e){d.closeDrawer(),o.doSave(e)},o.doHelloWorld=function(){r.getValue()&&!confirm("Do you really want to discard your changes?")||(r.setValue("\\documentclass{article}\n\n\\begin{document}\nHello, world!\n\\end{document}"),d.closeDrawer())};var p=function(e,t){t?o.savedMessage="Saved "+e+" at "+new Date:o.savedMessage="Saved "+e+" at "+new Date};o.viewInDrive=function(){return window.open(o.webViewLink)},o.startDriveIntegration=function(){console.log("Loading Google APIs...");var n=t.dom(e).querySelector("#realtimeApiLoader"),i=t.dom(e).querySelector("#driveApiLoader");newDriveAndRealtimePromise(i,n).then(function(e){var t=babelHelpers.slicedToArray(e,2),n=t[0],i=t[1];console.log("Google APIs loaded."),o.doSave=function(e){n.uploadTeXFile(o.fileId,r.getValue()).then(function(e){console.log("Saved.",e),p(e.result.name)},function(e){console.error("Cannot save file.",e),o.apiErrorMessage=e.error.message})};var a=function(e){var t=e.createString();t.setText(""),e.getRoot().set("PolyTeX-data",t)},l=function(e){var t=e.getModel(),n=t.getRoot().get("PolyTeX-data"),o=r.codeMirror,a=o.getDoc();n.addEventListener(i.api.EventType.TEXT_INSERTED,function(t){var n=a.posFromIndex(t.index);e.replaceRange(t.text,n)}),n.addEventListener(i.api.EventType.TEXT_DELETED,function(t){var n=a.posFromIndex(t.index),o=a.posFromIndex(t.index+t.text.length);e.replaceRange("",n,o)}),o.on("change",function(e,o){t.beginCompoundOperation();for(var r=o.from.line;r<o.to.line;r++){var i=a.indexFromPos({line:r,ch:o.from.ch}),l=a.indexFromPos({line:r,ch:o.to.ch});n.removeRange(i,l),n.insertString(i,o.text[r-o.from.line])}t.endCompoundOperation()})};n.createTeXFile(o.filename,{fields:"id,name,webViewLink"}).then(function(e){console.log("Created Google Drive file: "+e.result.name,e),o.fileId=e.result.id,o.webViewLink=e.result.webViewLink,i.load(e.result.id,l,a,function(e){return o.apiErrorMessage=e.toString()})})})}})}(document,Polymer);