var PDFTeX=function(e){e||(e="pdftex-worker.js");var o=new Worker(e);this.worker=o;var n=this,t=!1;n.on_stdout=function(e){console.log(e)},n.on_stderr=function(e){console.log(e)},o.onmessage=function(e){var o,t=JSON.parse(e.data);switch("command"in t||console.log("missing command!",t),t.command){case"ready":r.done(!0);break;case"stdout":case"stderr":n["on_"+t.command](t.contents);break;default:o=t.msg_id,"msg_id"in t&&o in i?i[o].done(t.result):console.warn("Unknown worker message "+o+"!")}};var r=new promise.Promise,i=[],a=void 0,l=function(e){var n=new promise.Promise,t=i.push(n)-1;return r.then(function(){e.msg_id=t,o.postMessage(JSON.stringify(e))}),n},c=function(){for(var e,o=1024,n=void 0,t=void 0,r=o,i=!0;Math.abs(r)>100;){i?(t=o,r="undefined"==typeof n?o:(n-o)/2):(n=o,r="undefined"==typeof t?-1*o/2:-1*(o-t)/2),o+=r,i=!0;try{e=String.fromCharCode.apply(null,new Uint8Array(o)),l({command:"test",data:e})}catch(a){i=!1}}return o},s=function(e){n[e]=function(){var o=[].concat.apply([],arguments);return l({command:e,arguments:o})}};s("FS_createDataFile"),s("FS_readFile"),s("FS_unlink"),s("FS_createFolder"),s("FS_createPath"),s("FS_createLazyFile"),s("FS_createLazyFilesFromList"),s("set_TOTAL_MEMORY");var d=function(e,o,n){return function(){return e[o].apply(e,n)}};n.compile=function(e){var o=new promise.Promise;return n.compileRaw(e).then(function(e){return e===!1?o.done(!1):(pdf_dataurl="data:application/pdf;charset=binary;base64,"+window.btoa(e),o.done(pdf_dataurl))}),o},n.compileRaw=function(e){"undefined"==typeof a&&(a=c());var o;o=t?[d(n,"FS_unlink",["/input.tex"])]:[d(n,"FS_createDataFile",["/","input.tex",e,!0,!0]),d(n,"FS_createLazyFilesFromList",["/","texlive.lst","./texlive",!0,!0])];var r=function(){return t=!0,l({command:"run",arguments:["-interaction=nonstopmode","-output-format","pdf","input.tex"]})},i=function(){return console.log(arguments),n.FS_readFile("/input.pdf")};return promise.chain(o).then(r).then(i)}},babelHelpers={};babelHelpers.classCallCheck=function(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")},babelHelpers.createClass=function(){function e(e,o){for(var n=0;n<o.length;n++){var t=o[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(o,n,t){return n&&e(o.prototype,n),t&&e(o,t),o}}();var WrappedPromise=function(){var e=this;this.promise=new Promise(function(o,n){e.resolve=o,e.reject=n})};WrappedPromise.prototype.done=function(e){this.resolve(e)},WrappedPromise.prototype.then=function(){return this.promise.then.apply(this.promise,arguments)};var chain=function e(o,n){var t=new WrappedPromise;return 0===o.length?t.done(n):o[0].apply(null,n).then(function(){o.splice(0,1),e(o,arguments).then(function(){t.done.apply(t,arguments)})}),t};window.promise={Promise:WrappedPromise,chain:chain};var CompilationService=function(){function e(){babelHelpers.classCallCheck(this,e),this.pdftex=new PDFTeX("bower_components/texlivejs/pdftex-worker.js")}return babelHelpers.createClass(e,[{key:"compile",value:function(e,o){var n=this;this.pdftex.worker.terminate(),this.pdftex=new PDFTeX("bower_components/texlivejs/pdftex-worker.js");var t=this.pdftex.set_TOTAL_MEMORY(83886080);return t.then(function(){return n.pdftex.on_stdout=o,n.pdftex.on_stderr=o,n.pdftex.compile(e)})}}]),e}();!function(e){"use strict";var o=new CompilationService,n=e.querySelector("#app");n.baseUrl="/",""===window.location.port&&(n.baseUrl="/PolyTeX/"),n.displayInstalledToast=function(){Polymer.dom(e).querySelector("platinum-sw-cache").disabled||Polymer.dom(e).querySelector("#caching-complete").show()},n.addEventListener("dom-change",function(){}),n.filename="PolyTeX",n.isCompiling=!1,n.codeMirrorOptions={mode:"stex",lineWrapping:!0,lineNumbers:!0},window.addEventListener("WebComponentsReady",function(){var t=Polymer.dom(e).querySelector("#editor"),r=Polymer.dom(e).querySelector("#generatePreviewButton"),i=Polymer.dom(e).querySelector("#compileProgress"),a=Polymer.dom(e).querySelector("#previewIFrame"),l=Polymer.dom(e).querySelector("#preview"),c=Polymer.dom(e).querySelector("#compileProblemToast"),s=Polymer.dom(e).querySelector("#compileLog"),d=Polymer.dom(e).querySelector("#compileLogTextArea");s.fitInto=l,n.showLog=function(e){s.toggle()},r.addEventListener("click",function(e){var r=new Date;if(n.isCompiling=!0,"in-progress"!==n.compileStatus){n.compileStatus="in-progress",console.log("Started compilation at "+r),d.value="";var l=function(e){void 0!==e&&null!==e&&(d.value+=e+"\n");var o=/Fatal error occurred, no output PDF file produced!$/;if(o.test(e)){var t=new Date;console.error(e),n.compilationError=e,c.open(),n.isCompiling=!1,n.compileStatus="error",console.log("Finished compilation at "+t),console.log("Execution time: "+(t-r)+"ms")}};o.compile(t.getValue(),l).then(function(e){if(console.log(e),!e)throw n.compileStatus="error",new Error("No PDF data URL");var o=new Date;n.isCompiling=!1,console.log("Finished compilation at "+o),console.log("Execution time: "+(o-r)+"ms"),e?(a.setAttribute("src",e),n.compileStatus="ok"):(a.setAttribute("src","about:blank"),n.compileStatus="error"),i.style.display="none"})["catch"](function(e){console.error(e),n.compilationError=e.message,c.open(),n.isCompiling=!1,n.compileStatus="error"})}});var p=Polymer.dom(e).querySelector("#drawerPanel");e.addEventListener("keydown",function(e){83==e.keyCode&&(navigator.platform.match("Mac")?e.metaKey:e.ctrlKey)&&(e.preventDefault(),p.closeDrawer(),saveAction())}),n.doHelloWorld=function(){t.getValue()&&!confirm("Do you really want to discard your changes?")||(t.setValue("\\documentclass{article}\n\n\\begin{document}\nHello, world!\n\\end{document}"),p.closeDrawer())},n.start=function(){gapi.client.load("drive","v3",function(){gapi.client.load("realtime","v2",function(){u()})})};var u=function(){var e={resource:{mimeType:"application/vnd.google-apps.drive-sdk",title:n.filename}};gapi.client.drive.files.insert(e).execute(function(e){console.log("hi"),console.dir(gapi),gapi.client.drive.realtime.load(e.id,function(e){m(e)})})},m=function(e){var e=gapi.client.drive.realtime.newInMemoryDocument(),o=e.getModel(),n=o.createString();o.getRoot().set("PolyTeX_data",n);var r=t.codeMirror,i=r.getDoc();n.addEventListener(gapi.client.drive.realtime.EventType.TEXT_INSERTED,function(o){var n=i.posFromIndex(o.index);e.replaceRange(o.text,n)}),n.addEventListener(gapi.client.drive.realtime.EventType.TEXT_DELETED,function(o){var n=i.posFromIndex(o.index),t=i.posFromIndex(o.index+o.text.length);e.replaceRange("",n,t)}),r.on("change",function(e,t){o.beginCompoundOperation();for(var r=t.from.line;r<t.to.line;r++){var a=i.indexFromPos({line:r,ch:from.ch}),l=i.indexFromPos({line:r,ch:to.ch});n.removeRange(a,l),n.insertString(a,t.text[r-t.from.line])}o.endCompoundOperation()})}})}(document);