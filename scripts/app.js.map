{"version":3,"file":"app.js","sources":["../../app/scripts/compilationservice.js","../../app/scripts/app.js"],"sourcesContent":["/* global PDFTeX */\n\n// Workaround for texlivejs not using a promise dependency\nvar WrappedPromise = function () {\n  this.promise = new Promise((resolve, reject) => {\n    this.resolve = resolve;\n    this.reject = reject;\n  });\n}\nWrappedPromise.prototype.done = function (v) {\n  this.resolve(v);\n};\nWrappedPromise.prototype.then = function () {\n  return this.promise.then.apply(this.promise, arguments);\n};\n\nvar chain = function (funcs, args) {\n  var p = new WrappedPromise();\n  if (funcs.length === 0) {\n    p.done(args);\n  } else {\n    funcs[0].apply(null, args).then(function () {\n      funcs.splice(0, 1);\n      chain(funcs, arguments).then(function () {\n        p.done.apply(p, arguments);\n      });\n    });\n  }\n  return p;\n};\nwindow.promise = {Promise: WrappedPromise, chain: chain};\n\nexport default class CompilationService {\n  constructor() {\n    this.pdftex = new PDFTeX('bower_components/texlivejs/pdftex-worker.js');\n  }\n\n  /**\n   * Compiles the specified LaTeX source.\n   *\n   * @param {string} source the source code\n   * @param {outputAppender} callback a function (called potentially multiple\n   * times) that handles a line of compilation output.\n   * @return a promise that resolves to a PDF data URL\n   */\n  compile(source, outputAppender) {\n    this.pdftex.worker.terminate();\n    this.pdftex = new PDFTeX('bower_components/texlivejs/pdftex-worker.js');\n    var p = this.pdftex.set_TOTAL_MEMORY(80 * 1024 * 1024);\n    return p.then(() => {\n      this.pdftex.on_stdout = outputAppender;\n      this.pdftex.on_stderr = outputAppender;\n      return this.pdftex.compile(source);\n    });\n  }\n}\n","import CompilationService from './compilationservice';\n((document) => {\n  'use strict';\n  const compilationService = new CompilationService();\n\n  var app = document.querySelector('#app');\n\n  app.baseUrl = '/';\n  if (window.location.port === '') {  // if production\n    // Uncomment app.baseURL below and\n    // set app.baseURL to '/your-pathname/' if running from folder in production\n    app.baseUrl = '/PolyTeX/';\n  }\n\n  app.displayInstalledToast = () => {\n    // Check to make sure caching is actually enabledâ€”it won't be in the dev environment.\n    if (!Polymer.dom(document).querySelector('platinum-sw-cache').disabled) {\n      Polymer.dom(document).querySelector('#caching-complete').show();\n    }\n  };\n\n  // Listen for template bound event to know when bindings have resolved and\n  // content has been stamped to the page\n  app.addEventListener('dom-change', () => {\n  });\n\n  app.filename = 'PolyTeX';\n  app.isCompiling = false;\n  app.codeMirrorOptions = {\n    mode: 'stex',\n    lineWrapping: true,\n    lineNumbers: true\n  };\n\n  window.addEventListener('WebComponentsReady', () => {\n    var editor = Polymer.dom(document).querySelector('#editor');\n    var generatePreviewButton = Polymer.dom(document).querySelector('#generatePreviewButton');\n    var compileProgress = Polymer.dom(document).querySelector('#compileProgress');\n    var previewIFrame = Polymer.dom(document).querySelector('#previewIFrame');\n    var preview = Polymer.dom(document).querySelector('#preview');\n    var compileProblemToast = Polymer.dom(document).querySelector('#compileProblemToast');\n    var compileLog = Polymer.dom(document).querySelector('#compileLog');\n    var compileLogTextArea = Polymer.dom(document).querySelector('#compileLogTextArea');\n\n    compileLog.fitInto = preview;\n\n    app.showLog = e => {\n      compileLog.toggle();\n    };\n\n    generatePreviewButton.addEventListener('click', e => {\n      var startTime = new Date();\n      app.isCompiling = true;\n      if (app.compileStatus === 'in-progress') {\n        return;\n      }\n      app.compileStatus = 'in-progress';\n      console.log('Started compilation at ' + startTime);\n\n      compileLogTextArea.value = '';\n      var outputListener = msg => {\n        // console.log(msg);\n        // Is this actually performant?\n        if (msg !== undefined && msg !== null) {\n          compileLogTextArea.value += msg + '\\n';\n        }\n        // workaround for PDFTeX not using promises correctly\n        var errorRE = /Fatal error occurred, no output PDF file produced!$/;\n        if (errorRE.test(msg)) {\n          var endTime = new Date();\n          console.error(msg);\n          app.compilationError = msg;\n          compileProblemToast.open();\n          app.isCompiling = false;\n          app.compileStatus = 'error';\n          console.log('Finished compilation at ' + endTime);\n          console.log('Execution time: ' + (endTime - startTime) + 'ms');\n        }\n      };\n\n      compilationService.compile(editor.getValue(), outputListener)\n        .then(pdfDataUrl => {\n          // workaround for PDFTeX not using promises correctly\n          console.log(pdfDataUrl);\n          if (!pdfDataUrl) {\n            app.compileStatus = 'error';\n            throw new Error('No PDF data URL');\n          }\n          var endTime = new Date();\n          app.isCompiling = false;\n\n          console.log('Finished compilation at ' + endTime);\n          console.log('Execution time: ' + (endTime - startTime) + 'ms');\n          if (pdfDataUrl) {\n            previewIFrame.setAttribute('src', pdfDataUrl);\n            app.compileStatus = 'ok';\n          } else {\n            previewIFrame.setAttribute('src', 'about:blank');\n            app.compileStatus = 'error';\n          }\n          compileProgress.style.display = 'none';\n        }).catch(e => {\n          // TODO: refactor this out\n          console.error(e);\n          app.compilationError = e.message;\n          compileProblemToast.open();\n          app.isCompiling = false;\n          app.compileStatus = 'error';\n        });\n    });\n\n    var drawerPanel = Polymer.dom(document).querySelector('#drawerPanel');\n    document.addEventListener('keydown', e => {\n      if (e.keyCode == 83 && (navigator.platform.match('Mac') ? e.metaKey : e.ctrlKey)) {\n        e.preventDefault();\n        drawerPanel.closeDrawer();\n        saveAction();\n      }\n    });\n\n    // used by #helloWorldItem\n    app.doHelloWorld = () => {\n      if (editor.getValue() && !confirm('Do you really want to discard your changes?')) {\n        return;\n      }\n      editor.setValue('\\\\documentclass{article}\\n\\n\\\\begin{document}\\nHello, world!\\n\\\\end{document}');\n      drawerPanel.closeDrawer();\n    };\n\n    // 707726290441-2t740vcema93b7jad2acqiku87qe25s6.apps.googleusercontent.com\n    // var authProblemToast = Polymer.dom(document).querySelector('#authProblemToast')\n    // gapi.load('client', () => {\n    //   gapi.client.load('drive', 'v3', () => {\n    //     gapi.client.load('realtime', 'v2', () => {\n    //       gapi.auth.authorize({\n    //         client_id: CLIENT_ID,\n    //         scope: SCOPES,\n    //         immediate: true\n    //       }, response => {\n    //         if (response.error) {\n    //           console.debug('Google API not authorized.');\n    //         } else {\n    //           start();\n    //         }\n    //       });\n    //     });\n    //   });\n    // });\n\n    app.start = () => {\n      gapi.client.load('drive', 'v3', () => {\n        gapi.client.load('realtime', 'v2', () => {\n          go();\n        });\n      });\n    };\n    var go = () => {\n      var insertHash = {\n        'resource': {\n          mimeType: 'application/vnd.google-apps.drive-sdk',\n          title: app.filename\n        }\n      };\n      gapi.client.drive.files.insert(insertHash).execute(createResponse => {\n        // TODO: id\n        console.log('hi');\n        console.dir(gapi);\n        gapi.client.drive.realtime.load(createResponse.id, doc => {\n          wire(doc);\n        });\n      });\n    };\n\n    var wire = doc => {\n      var doc = gapi.client.drive.realtime.newInMemoryDocument();\n      var model = doc.getModel();\n      var collaborativeString = model.createString();\n      model.getRoot().set('PolyTeX_data', collaborativeString);\n      var codeMirror = editor.codeMirror;\n      var codeMirrorDoc = codeMirror.getDoc();\n      collaborativeString.addEventListener(gapi.client.drive.realtime.EventType.TEXT_INSERTED, e => {\n        var pos = codeMirrorDoc.posFromIndex(e.index);\n        // inserts if you call with only one position argument\n        doc.replaceRange(e.text, pos);\n      });\n      collaborativeString.addEventListener(gapi.client.drive.realtime.EventType.TEXT_DELETED, e => {\n        var start = codeMirrorDoc.posFromIndex(e.index);\n        var end = codeMirrorDoc.posFromIndex(e.index + e.text.length);\n        doc.replaceRange('', start, end);\n      });\n      codeMirror.on('change', (_, e) => {\n        model.beginCompoundOperation();\n        for (let line = e.from.line; line < e.to.line; line++) {\n          var start = codeMirrorDoc.indexFromPos({line: line, ch: from.ch});\n          var end = codeMirrorDoc.indexFromPos({line: line, ch: to.ch});\n          collaborativeString.removeRange(start, end);\n          collaborativeString.insertString(start, e.text[line - e.from.line]);\n        }\n        model.endCompoundOperation();\n      });\n    };\n\n\n\n  });\n\n})(document);\n"],"names":[],"mappings":"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"}