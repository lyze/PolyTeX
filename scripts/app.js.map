{"version":3,"file":"app.js","sources":["../../app/scripts/compilationservice.js","../../app/scripts/app.js"],"sourcesContent":["/* global PDFTeX */\n\n// Workaround for texlivejs not using a promise dependency\nvar WrappedPromise = function () {\n  this.promise = new Promise((resolve, reject) => {\n    this.resolve = resolve;\n    this.reject = reject;\n  });\n}\nWrappedPromise.prototype.done = function (v) {\n  this.resolve(v);\n};\nWrappedPromise.prototype.then = function () {\n  return this.promise.then.apply(this.promise, arguments);\n};\n\nvar chain = function (funcs, args) {\n  var p = new WrappedPromise();\n  if (funcs.length === 0) {\n    p.done(args);\n  } else {\n    funcs[0].apply(null, args).then(function () {\n      funcs.splice(0, 1);\n      chain(funcs, arguments).then(function () {\n        p.done.apply(p, arguments);\n      });\n    });\n  }\n  return p;\n};\nwindow.promise = {Promise: WrappedPromise, chain: chain};\n\nexport default class CompilationService {\n  constructor() {\n    this.pdftex = new PDFTeX('bower_components/texlivejs/pdftex-worker.js');\n  }\n\n  /**\n   * Compiles the specified LaTeX source.\n   *\n   * @param {string} source the source code\n   * @param {outputAppender} callback a function (called potentially multiple\n   * times) that handles a line of compilation output.\n   * @return a promise that resolves to a PDF data URL\n   */\n  compile(source, outputAppender) {\n    this.pdftex.worker.terminate();\n    this.pdftex = new PDFTeX('bower_components/texlivejs/pdftex-worker.js');\n    var p = this.pdftex.set_TOTAL_MEMORY(80 * 1024 * 1024);\n    return p.then(() => {\n      this.pdftex.on_stdout = outputAppender;\n      this.pdftex.on_stderr = outputAppender;\n      return this.pdftex.compile(source);\n    });\n  }\n}\n","/* global Polymer */\n// Copyright David Xu, 2016\nimport CompilationService from './compilationservice';\n\n\n((document) => {\n  'use strict';\n  const compilationService = new CompilationService();\n\n  var app = document.querySelector('#app');\n\n  app.a11yTarget = document.body;\n\n  app.displayInstalledToast = () => {\n    // Check to make sure caching is actually enabledâ€”it won't be in the dev environment.\n    if (!Polymer.dom(document).querySelector('platinum-sw-cache').disabled) {\n      Polymer.dom(document).querySelector('#caching-complete').show();\n    }\n  };\n\n  app.endCloudIntegration = () => {\n    // no-op; actual implementation defined later when app is ready.\n  };\n\n  app.isConnectCloudItemDisabled = cloudStatus =>\n    ['loading', 'unavailable', 'authorizing'].includes(cloudStatus);\n\n  app.isConnectCloudItemHidden = cloudStatus =>\n    !['loading', 'unavailable', 'unauthorized', 'authorizing'].includes(\n      cloudStatus);\n\n  app.isCloudFileConnected = cloudStatus =>\n    ['loaded', 'dirty', 'saving', 'saved'].includes(cloudStatus);\n\n  const editorHasCloudFile = () =>\n    ['loaded', 'dirty', 'saving', 'saved'].includes(app.cloudStatus);\n\n  // Listen for template bound event to know when bindings have resolved and\n  // content has been stamped to the page\n  app.addEventListener('dom-change', () => {\n  });\n\n  app.filename = 'untitled.tex';\n  app.isCompiling = false;\n\n  app.codeMirrorOptions = {\n    mode: 'stex',\n    lineWrapping: true,\n    lineNumbers: true\n  };\n\n\n  window.addEventListener('WebComponentsReady', () => {\n    var filenameInput = Polymer.dom(document).querySelector('#filenameInput');\n\n    var editor = Polymer.dom(document).querySelector('#editor');\n    var generatePreviewButton = Polymer.dom(document).querySelector('#generatePreviewButton');\n    var compileProgress = Polymer.dom(document).querySelector('#compileProgress');\n    var previewIFrame = Polymer.dom(document).querySelector('#previewIFrame');\n    var preview = Polymer.dom(document).querySelector('#preview');\n    var compileProblemToast = Polymer.dom(document).querySelector('#compileProblemToast');\n    var compileLog = Polymer.dom(document).querySelector('#compileLog');\n    var compileLogTextArea = Polymer.dom(document).querySelector('#compileLogTextArea');\n\n    var apiErrorToast = Polymer.dom(document).querySelector('#apiErrorToast');\n\n    var googleSignIn = Polymer.dom(document).querySelector('#googleSignIn');\n\n    app.updateFilename = (e, detail) => {\n      filenameInput.input.blur();\n      app.filename = filenameInput.value;\n    };\n\n    compileLog.fitInto = preview;\n    app.toggleCompileLog = _ => {\n      compileLog.toggle();\n    };\n\n    generatePreviewButton.addEventListener('click', e => {\n      var startTime = new Date();\n      app.isCompiling = true;\n      if (app.compileStatus === 'in-progress') {\n        return;\n      }\n      app.compileStatus = 'in-progress';\n      console.log('Started compilation at ' + startTime);\n\n      compileLogTextArea.value = '';\n      compileLog.refit();\n      var outputListener = msg => {\n        // console.log(msg);\n        // Is this actually performant?\n        if (msg !== undefined && msg !== null) {\n          compileLogTextArea.value += msg + '\\n';\n          compileLog.refit();\n        }\n        // workaround for PDFTeX not using promises correctly\n        var errorRE = /Fatal error occurred, no output PDF file produced!$/;\n        if (errorRE.test(msg)) {\n          var endTime = new Date();\n          console.error(msg);\n          app.compilationError = msg;\n          app.isCompiling = false;\n          app.compileStatus = 'error';\n          console.log('Finished compilation at ' + endTime);\n          console.log('Execution time: ' + (endTime - startTime) + 'ms');\n        }\n      };\n\n      compilationService.compile(editor.getValue(), outputListener)\n        .then(pdfDataUrl => {\n          // workaround for PDFTeX not using promises correctly\n          console.log(pdfDataUrl);\n          if (!pdfDataUrl) {\n            app.compileStatus = 'error';\n            throw new Error('No PDF data URL');\n          }\n          var endTime = new Date();\n          app.isCompiling = false;\n\n          console.log('Finished compilation at ' + endTime);\n          console.log('Execution time: ' + (endTime - startTime) + 'ms');\n          if (pdfDataUrl) {\n            previewIFrame.setAttribute('src', pdfDataUrl);\n            app.compileStatus = 'ok';\n          } else {\n            previewIFrame.setAttribute('src', 'about:blank');\n            app.compileStatus = 'error';\n          }\n          compileProgress.style.display = 'none';\n        }).catch(e => {\n          // TODO: refactor this out\n          console.error(e);\n          app.compilationError = e.message;\n          app.isCompiling = false;\n          app.compileStatus = 'error';\n        });\n    });\n\n    var drawerPanel = Polymer.dom(document).querySelector('#drawerPanel');\n    app.doSaveItemAction = (...args) => {\n      if (editorHasCloudFile()) {\n        drawerPanel.closeDrawer();\n        app.doManualSave(...args);\n      }\n    };\n\n    // used by #helloWorldItem\n    app.doHelloWorld = () => {\n      if (editor.getValue() && !confirm('Do you really want to discard your changes?')) {\n        return;\n      }\n      editor.setValue('\\\\documentclass{article}\\n\\n\\\\begin{document}\\nHello, world!\\n\\\\end{document}');\n      drawerPanel.closeDrawer();\n    };\n\n    app.connectCloud = () => {\n      drawerPanel.closeDrawer();\n      editor.connectCloud().catch(_ => {\n        // no-op\n        // app.apiErrorMessage = 'Failed to connect to Google Drive.';\n      });\n    };\n\n    app.disconnectCloud = () => {\n      drawerPanel.closeDrawer();\n      editor.endCloudIntegration();\n    };\n\n    app.startCloudIntegration = () => {\n      editor.startCloudIntegration();\n    };\n\n    app.endCloudIntegration = () => {\n      app.webViewLink = null;\n      app.lastCloudModificationTime = null;\n      editor.endCloudIntegration();\n    };\n\n    editor.addEventListener('cloud-ready', () => {\n    });\n\n    editor.addEventListener('cloud-file-loaded', e => {\n      var {id, name, webViewLink, createdTime, modifiedTime} = e.detail.result;\n      if (createdTime) {\n        app.savedMessage = `Created ${name} at ${new Date(createdTime)}`;\n      }\n      if (modifiedTime) {\n        app.lastCloudModificationTime = new Date(modifiedTime);\n      }\n\n      app.doManualSave = (e, detail) => {\n        editor.save().then(\n          _ => app.savedMessage = `Saved ${name} at ${new Date()}`,\n          r => app.apiErrorMessage = r.error.message);\n        // workaround for e.preventDefault() for ctrl+s\n        detail.keyboardEvent.preventDefault();\n      };\n    });\n\n    app.maybeStartCloudIntegration = () => {\n      // TODO: drive integration from google signin\n    };\n\n  }); // WebComponentsReady\n\n})(document);\n"],"names":[],"mappings":"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"}